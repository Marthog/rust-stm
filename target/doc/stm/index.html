<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <meta name="description" content="API documentation for the Rust `stm` crate.">
    <meta name="keywords" content="rust, rustlang, rust-lang, stm">

    <title>stm - Rust</title>

    <link rel="stylesheet" type="text/css" href="../main.css">

    
    
</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

    

    <nav class="sidebar">
        
        <p class='location'></p><script>window.sidebarCurrent = {name: 'stm', ty: 'mod', relpath: '../'};</script>
    </nav>

    <nav class="sub">
        <form class="search-form js-only">
            <div class="search-container">
                <input class="search-input" name="search"
                       autocomplete="off"
                       placeholder="Click or press ‘S’ to search, ‘?’ for more options…"
                       type="search">
            </div>
        </form>
    </nav>

    <section id='main' class="content mod">
<h1 class='fqn'><span class='in-band'>Crate <a class='mod' href=''>stm</a></span><span class='out-of-band'><span id='render-detail'>
            <a id="toggle-all-docs" href="javascript:void(0)" title="collapse all docs">
                [<span class='inner'>&#x2212;</span>]
            </a>
        </span><a id='src-0' class='srclink' href='../src/stm/lib.rs.html#1-188' title='goto source code'>[src]</a></span></h1>
<div class='docblock'><p>This library implements <a href="https://en.wikipedia.org/wiki/Software_transactional_memory">software transactional memory</a>,
often abbreviated with STM.</p>

<p>It is designed closely to haskells STM library. Read Simon Marlow&#39;s
<a href="http://chimera.labs.oreilly.com/books/1230000000929/ch10.html">Parallel and Concurrent Programming in Haskell</a>
for more info. Especially the chapter about <a href="http://chimera.labs.oreilly.com/books/1230000000929/ch10.html#sec_stm-cost">Performance</a>
is also important for using STM in rust.</p>

<p>With locks the sequence
of two threadsafe actions is no longer threadsafe because
other threads may interfer in between of these actions.
Applying another lock may lead to common sources of errors
like deadlocks and forgotten locks.</p>

<p>Unlike locks Software transactional memory is composable.
It is typically implemented by writing all read and write
operations in a log. When the action has finished, the reads
are checked for consistency and depending on the result
either the writes are committed in a single atomic operation
or the result is discarded and the computation run again.</p>

<h1 id="usage" class='section-header'><a
                           href="#usage">Usage</a></h1>
<p>STM operations are safed inside the type <code>STM&lt;T&gt;</code> where T
is the return type of the inner operation. They are created with <code>stm!</code>:</p>
<pre class='rust rust-example-rendered'>
<span class='kw'>let</span> <span class='ident'>transaction</span> <span class='op'>=</span> <span class='macro'>stm</span><span class='macro'>!</span>({
    <span class='comment'>// some action</span>
    <span class='comment'>// return value (or empty for unit)</span>
});</pre>

<p>and can then be run by calling.</p>
<pre class='rust rust-example-rendered'>
<span class='ident'>transaction</span>.<span class='ident'>atomically</span>();
</pre>

<p>For running an STM-Block inside of another
use the macro <code>stm_call!</code>:</p>
<pre class='rust rust-example-rendered'>
<span class='kw'>use</span> <span class='ident'>stm</span>::<span class='ident'>Var</span>;
<span class='kw'>let</span> <span class='ident'>var</span> <span class='op'>=</span> <span class='ident'>Var</span>::<span class='ident'>new</span>(<span class='number'>0</span>);
<span class='kw'>let</span> <span class='ident'>var2</span> <span class='op'>=</span> <span class='ident'>var</span>.<span class='ident'>clone</span>(); <span class='comment'>// clone so that it can be send to a closure</span>
<span class='kw'>let</span> <span class='ident'>modify</span> <span class='op'>=</span> <span class='macro'>stm</span><span class='macro'>!</span>({
    <span class='ident'>var2</span>.<span class='ident'>write</span>(<span class='number'>42</span>);
});

<span class='kw'>let</span> <span class='ident'>x</span> <span class='op'>=</span> <span class='macro'>stm</span><span class='macro'>!</span>({
    <span class='macro'>stm_call</span><span class='macro'>!</span>(<span class='ident'>modify</span>);
    <span class='ident'>var</span>.<span class='ident'>read</span>()  <span class='comment'>// return the value saved in var</span>
}).<span class='ident'>atomically</span>();

<span class='macro'>println</span><span class='macro'>!</span>(<span class='string'>&quot;var = {}&quot;</span>, <span class='ident'>x</span>);
</pre>

<h1 id="stm-safety" class='section-header'><a
                           href="#stm-safety">STM safety</a></h1>
<p>Software transactional memory is completely safe in the terms
that rust considers safe. Still there are multiple rules that
you should obey when dealing with software transactional memory:</p>

<ul>
<li>Don&#39;t run code with side effects, especially no IO-code,
because stm is designed to be run multiple times. Return a
closure if you have to.</li>
<li>Don&#39;t run an STM-Block by calling <code>STM::atomically</code> inside of
another because your thread will
immediately panic. When you use STM in the inner of a function then
return a STM-Object instead so that callers can safely compose it into
larger blocks.</li>
<li>Don&#39;t mix locks and STM. Your code will easily deadlock and slow
down on unpredictably.</li>
<li>When you put an <code>Arc</code> into a <code>Var</code> don&#39;t use inner mutability
to modify it since the inner still points to the original value.</li>
<li>Don&#39;t call <code>Var::read</code> or <code>Var::write</code> from outside of a STM block.
Instead start a STM or use <code>Var::read_atomic</code> for it.</li>
</ul>

<h1 id="speed" class='section-header'><a
                           href="#speed">Speed</a></h1>
<p>Generally keep your atomic blocks as small as possible bacause
the more time you spend the more likely it is to collide with
other threads. For STM reading vars is quite slow because it
need to look them up in the log every time they are written to
and every used var increases the chance of collisions. You should
keep the amount of accessed variables as low as needed.</p>
</div><h2 id='macros' class='section-header'><a href="#macros">Macros</a></h2>
<table>
                    <tr class=' module-item'>
                        <td><a class='macro' href='macro.stm!.html'
                               title='stm::stm!'>stm!</a></td>
                        <td class='docblock short'>
                             <p>declare a block that uses STM</p>

                        </td>
                    </tr>
                
                    <tr class=' module-item'>
                        <td><a class='macro' href='macro.stm_call!.html'
                               title='stm::stm_call!'>stm_call!</a></td>
                        <td class='docblock short'>
                             <p>call a STM function from inside of a STM block</p>

                        </td>
                    </tr>
                </table><h2 id='structs' class='section-header'><a href="#structs">Structs</a></h2>
<table>
                    <tr class=' module-item'>
                        <td><a class='struct' href='struct.STM.html'
                               title='stm::STM'>STM</a></td>
                        <td class='docblock short'>
                             <p>class representing a STM computation</p>

                        </td>
                    </tr>
                
                    <tr class=' module-item'>
                        <td><a class='struct' href='struct.Var.html'
                               title='stm::Var'>Var</a></td>
                        <td class='docblock short'>
                             <p>A variable that can be used in a STM-Block</p>

                        </td>
                    </tr>
                </table><h2 id='enums' class='section-header'><a href="#enums">Enums</a></h2>
<table>
                    <tr class=' module-item'>
                        <td><a class='enum' href='enum.StmResult.html'
                               title='stm::StmResult'>StmResult</a></td>
                        <td class='docblock short'>
                             <p>a result of each step of a STM calculation</p>

                        </td>
                    </tr>
                </table><h2 id='functions' class='section-header'><a href="#functions">Functions</a></h2>
<table>
                    <tr class=' module-item'>
                        <td><a class='fn' href='fn.retry.html'
                               title='stm::retry'>retry</a></td>
                        <td class='docblock short'>
                             <p>call retry in <code>stm_call!</code> to let the STM manually run again</p>

                        </td>
                    </tr>
                </table></section>
    <section id='search' class="content hidden"></section>

    <section class="footer"></section>

    <aside id="help" class="hidden">
        <div>
            <h1 class="hidden">Help</h1>

            <div class="shortcuts">
                <h2>Keyboard Shortcuts</h2>

                <dl>
                    <dt>?</dt>
                    <dd>Show this help dialog</dd>
                    <dt>S</dt>
                    <dd>Focus the search field</dd>
                    <dt>&larrb;</dt>
                    <dd>Move up in search results</dd>
                    <dt>&rarrb;</dt>
                    <dd>Move down in search results</dd>
                    <dt>&#9166;</dt>
                    <dd>Go to active search result</dd>
                </dl>
            </div>

            <div class="infos">
                <h2>Search Tricks</h2>

                <p>
                    Prefix searches with a type followed by a colon (e.g.
                    <code>fn:</code>) to restrict the search to a given type.
                </p>

                <p>
                    Accepted types are: <code>fn</code>, <code>mod</code>,
                    <code>struct</code>, <code>enum</code>,
                    <code>trait</code>, <code>type</code>, <code>macro</code>,
                    and <code>const</code>.
                </p>

                <p>
                    Search functions by type signature (e.g.
                    <code>vec -> usize</code>)
                </p>
            </div>
        </div>
    </aside>

    

    <script>
        window.rootPath = "../";
        window.currentCrate = "stm";
        window.playgroundUrl = "";
    </script>
    <script src="../jquery.js"></script>
    <script src="../main.js"></script>
    
    <script async src="../search-index.js"></script>
</body>
</html>